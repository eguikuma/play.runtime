<div align="right">
<img src="https://img.shields.io/badge/AI-ASSISTED_STUDY-3b82f6?style=for-the-badge&labelColor=1e293b&logo=bookstack&logoColor=white" alt="AI Assisted Study" />
</div>

# WebAssembly は何が新しいのか

## はじめに

[03-vm](../03-vm.md) で、WebAssembly（Wasm）について簡単に触れました

「Web ブラウザで高速に実行できるバイナリ形式」「言語に依存しない新しい共通語」と紹介しました

しかし、JVM も「プラットフォーム非依存」を実現していました

WebAssembly は、JVM と何が違うのでしょうか？

このページでは、WebAssembly の設計思想と、その新しさを深掘りします

---

## 目次

1. [WebAssembly の誕生](#webassembly-の誕生)
2. [WebAssembly の設計目標](#webassembly-の設計目標)
3. [バイナリ形式](#バイナリ形式)
4. [セキュリティモデル](#セキュリティモデル)
5. [ブラウザ外での活用](#ブラウザ外での活用)
6. [WASI：システムインターフェース](#wasシステムインターフェース)
7. [用語集](#用語集)
8. [参考資料](#参考資料)

---

## WebAssembly の誕生

### Web のパフォーマンス問題

JavaScript は、Web の唯一のプログラミング言語でした

しかし、JavaScript には限界がありました

- 動的型付けによるオーバーヘッド（実行時に型を判定するコストがかかる）
- テキスト形式のパースコスト
- 予測しにくい最適化

ゲームや画像処理など、パフォーマンスが重要なアプリケーションには不十分でした

### asm.js から WebAssembly へ

Mozilla は<strong>asm.js</strong>を発表しました

asm.js は、JavaScript の厳密なサブセットで、高速に実行できるように設計されていました

```javascript
/*
 * asm.js の例
 */
function add(x, y) {
  /*
   * x は整数であることを明示
   */
  x = x | 0;
  /*
   * y は整数であることを明示
   */
  y = y | 0;
  return (x + y) | 0;
}
```

しかし、asm.js はテキスト形式であり、パースのオーバーヘッドがありました

その後、asm.js の教訓を活かして WebAssembly の設計が始まりました

そして、主要ブラウザで WebAssembly がサポートされるようになりました

---

## WebAssembly の設計目標

WebAssembly は、以下の目標を持って設計されました

### 高速な実行

ネイティブコードに近い速度で実行できることを目指しています

バイナリ形式により、パースとコンパイルが高速です

### 高速なロード

コンパクトなバイナリ形式により、ネットワーク転送が速くなります

ストリーミングコンパイルにより、ダウンロード完了を待たずにコンパイルを開始できます

### 安全性

サンドボックス内で実行され、ホスト環境へのアクセスは明示的に許可されたものだけです

### 言語非依存

特定の言語に依存せず、様々な言語からコンパイルできます

| 言語           | Wasm へのコンパイル |
| -------------- | ------------------- |
| C/C++          | Emscripten、clang   |
| Rust           | rustc               |
| Go             | TinyGo、Go 標準     |
| AssemblyScript | asc                 |

### JVM との比較

| 観点         | JVM                          | WebAssembly                  |
| ------------ | ---------------------------- | ---------------------------- |
| 対象言語     | Java 系言語中心              | 言語非依存                   |
| バイトコード | 高レベル                     | 低レベル                     |
| GC           | 組み込み                     | オプション（言語が実装）     |
| 起動         | 遅め（JIT のウォームアップ） | 速い                         |
| 用途         | サーバー、アプリ             | ブラウザ、エッジ、プラグイン |

---

## バイナリ形式

### 構造

WebAssembly のバイナリ形式（.wasm）は、<strong>モジュール</strong>として構成されます

```
モジュール
├── マジックナンバー（0x00 0x61 0x73 0x6D = "\0asm"）
├── バージョン（0x01 0x00 0x00 0x00 = version 1）
└── セクション
    ├── Type セクション（関数シグネチャ）
    ├── Import セクション（インポート）
    ├── Function セクション（関数インデックス）
    ├── Table セクション
    ├── Memory セクション
    ├── Global セクション
    ├── Export セクション（エクスポート）
    ├── Start セクション
    ├── Element セクション
    ├── Code セクション（関数本体）
    └── Data セクション
```

### スタックベースの仮想マシン

WebAssembly は、JVM と同様にスタックベースです

```wasm
;; 1 + 2 を計算（WAT テキスト形式）
i32.const 1    ;; スタックに 1 を積む
i32.const 2    ;; スタックに 2 を積む
i32.add        ;; 2 つを足して結果をスタックに
```

### 型システム

WebAssembly は、以下の基本型を持ちます

| 型        | 説明                |
| --------- | ------------------- |
| i32       | 32 ビット整数       |
| i64       | 64 ビット整数       |
| f32       | 32 ビット浮動小数点 |
| f64       | 64 ビット浮動小数点 |
| v128      | 128 ビット SIMD     |
| funcref   | 関数参照            |
| externref | 外部参照            |

高レベルな型（オブジェクト、文字列など）は、言語やツールチェーンが実装します

---

## セキュリティモデル

### サンドボックス

WebAssembly は、厳密なサンドボックス内で実行されます

| 制限           | 説明                               |
| -------------- | ---------------------------------- |
| メモリ         | 自分のリニアメモリのみアクセス可能 |
| ファイル       | 直接アクセス不可                   |
| ネットワーク   | 直接アクセス不可                   |
| システムコール | 直接呼び出し不可                   |

外部リソースへのアクセスは、<strong>インポート</strong>を通じて行います

ホスト環境が、どの機能を Wasm モジュールに提供するかを制御します

### リニアメモリ

WebAssembly のメモリは、<strong>リニアメモリ</strong>と呼ばれる連続したバイト配列です

```
┌──────────────────────────────────────────┐
│          リニアメモリ（64KB 単位で拡張）   │
│  [0x0000]  [0x0001]  [0x0002]  ...       │
└──────────────────────────────────────────┘
```

- 初期サイズと最大サイズを指定
- 範囲外アクセスはトラップ（エラー）
- ホストのメモリへは直接アクセスできない

### バイトコード検証

JVM と同様に、WebAssembly もバイトコードを検証します

- 型の整合性
- スタックの整合性
- メモリアクセスの妥当性

検証を通過したモジュールだけが実行されます

---

## ブラウザ外での活用

WebAssembly は「Web」という名前ですが、ブラウザ外でも活用されています

### サーバーサイド

Node.js や Deno で WebAssembly を実行できます

### エッジコンピューティング

<strong>エッジコンピューティング</strong>とは、ユーザーに近い場所（CDN の拠点など）で処理を行う手法です

Cloudflare Workers、Fastly Compute などで WebAssembly が使われています

軽量で高速な起動が、エッジ環境に適しています

### プラグインシステム

アプリケーションの拡張機構として WebAssembly が使われています

| プロジェクト | 用途               |
| ------------ | ------------------ |
| Envoy        | プロキシのフィルタ |
| Figma        | プラグイン         |
| VS Code      | 拡張機能（一部）   |

サンドボックスにより、プラグインがホストアプリケーションを破壊するリスクを軽減できます

### コンテナの代替

「Wasm はコンテナの代替になる」という議論があります

Docker の共同創設者 Solomon Hykes は、以下のように述べました

> 「2008 年に WASM + WASI が存在していたら、Docker を作る必要はなかった」

WebAssembly + WASI は、軽量で移植性が高く、セキュアな実行環境を提供します

---

## WASI：システムインターフェース

### WASI とは

<strong>WASI（WebAssembly System Interface）</strong>は、WebAssembly からシステム機能にアクセスするための標準インターフェースです

ブラウザ外で WebAssembly を実行するとき、ファイルアクセスやネットワーク通信が必要になります

WASI は、これらの機能を安全に提供します

### 機能

WASI は、以下のような機能カテゴリを提供します

| 機能カテゴリ | 説明                                 |
| ------------ | ------------------------------------ |
| ファイル操作 | ファイルの読み書き、ディレクトリ操作 |
| ネットワーク | TCP/UDP ソケット通信                 |
| 環境情報     | 環境変数、コマンドライン引数         |
| 時刻         | システム時刻の取得                   |
| 乱数         | 暗号学的に安全な乱数生成             |

### ケーパビリティベースのセキュリティ

WASI は、<strong>ケーパビリティベースのセキュリティ</strong>を採用しています

プログラムは、明示的に与えられたリソースにのみアクセスできます

```bash
# /tmp ディレクトリへのアクセスを許可して実行
wasmtime --dir=/tmp myprogram.wasm
```

これは、カーネル空間の学習で学んだ Linux のケーパビリティに似た考え方です

---

## 用語集

| 用語                     | 英語                         | 説明                             |
| ------------------------ | ---------------------------- | -------------------------------- |
| WebAssembly              | WebAssembly / Wasm           | Web 向けの移植可能なバイナリ形式 |
| WASI                     | WebAssembly System Interface | システム機能へのインターフェース |
| モジュール               | Module                       | Wasm のコンパイル単位            |
| リニアメモリ             | Linear Memory                | 連続したバイト配列としてのメモリ |
| WAT                      | WebAssembly Text Format      | Wasm のテキスト形式              |
| Emscripten               | Emscripten                   | C/C++ から Wasm へのコンパイラ   |
| asm.js                   | asm.js                       | WebAssembly の前身               |
| ストリーミングコンパイル | Streaming Compilation        | ダウンロードしながらコンパイル   |
| ケーパビリティ           | Capability                   | アクセス権を表すトークン         |
| トラップ                 | Trap                         | Wasm 実行時のエラー              |

---

## 参考資料

このページの内容は、以下のソースに基づいています

<strong>WebAssembly 仕様</strong>

- [WebAssembly Specification](https://webassembly.github.io/spec/)
  - WebAssembly の公式仕様

<strong>WASI</strong>

- [WASI](https://wasi.dev/)
  - WASI の公式サイト

<strong>ランタイム</strong>

- [Wasmtime](https://wasmtime.dev/)
  - Bytecode Alliance の Wasm ランタイム
- [Wasmer](https://wasmer.io/)
  - 汎用の Wasm ランタイム

<strong>本編との関連</strong>

- [03-vm](../03-vm.md)
  - 仮想マシンの基本
